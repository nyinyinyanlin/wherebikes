<html>
  <head>
    <title></title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"
            integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
            crossorigin="anonymous"></script>
    <script src="https://cdn.rawgit.com/mgalante/jquery.redirect/master/jquery.redirect.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"
          integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ=="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"
            integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log=="
            crossorigin=""></script>
    <style>
      html, body, #map {
        height: 100%;
        width: 100vw;
        margin: 0;
        padding: 0;
      }

      body {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      #container {
        width: 100vw;
        height: 100%;
        background-color: white;
        position: absolute;
        display: none;
        overflow: scroll;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        z-index: 4;
      }

      #map {
        position: absolute;
        display: block;
        z-index: 1;
      }

      #msg {
        position: absolute;
        top: 2%;
        height: 24px;
        width: auto;
        text-align: center;
        background-color: white;
        border-radius: 5px;
        padding: 2px 8px 2px 8px;
        box-shadow: 0px 0px 2px 1px #888888;
        z-index: 2;
      }

      #gpscheckbox {
        position: absolute;
        bottom: 5%;
        left: 3%;
        width: auto;
        padding: 2px 8px 2px 5px;
        border-radius: 5px;
        background-color: white;
        box-shadow: 0px 0px 2px 1px #888888;
        z-index: 3;
      }

      #gpscb {
        vertical-align: middle;
        height: 16px;
        width: 16px;
      }

      #mapstylecheckbox {
        position: absolute;
        bottom: 5%;
        right: 3%;
        width: auto;
        padding: 2px 8px 2px 5px;
        border-radius: 5px;
        background-color: white;
        box-shadow: 0px 0px 2px 1px #888888;
        z-index: 3;
      }

      #mapstylecb {
        vertical-align: middle;
        height: 16px;
        width: 16px;
      }

      .visible {
        visibility: visible;
      }

      .bs .bp .br {
        display: table-row;
      }

      table {
        width: 100%;
      }

      table tr {
        width: 100%;
      }

      table tr td {
        width: 60%;
      }

      table tr td:first-child {
        text-align: right;
        width: 40%;
      }
    </style>
  </head>
  <body>
     <div id="container">
      <table>
        <tr class="visible">
          <td>Category:</td>
          <td>
            <select size="1" id="category">
              <option value="shop=bicycle">Bicycle Shop</option>
              <option value="amenity=bicycle_parking">Bicycle Parking</option>
              <option value="amenity=bicycle_rental">Bicycle Rental</option>
            </select>
          </td>
        </tr>
        <tr class="bs bp br">
          <td>Name (EN)</td>
          <td><input id="name:en" type="text"></input></td>
        </tr>
        <tr class="bs bp br">
          <td>Name (MY)</td>
          <td><input id="name:my" type="text"></input></td>
        </tr>
        <tr class="bs">
          <td>Address</td>
          <td><input id="addr" type="text"></input></td>
        </tr>
        <tr class="bs">
          <td>Retail</td>
          <td><input id="service:bicycle:retail" type="checkbox"></input></td>
        </tr>
        <tr class="bs">
          <td>Repair</td>
          <td><input id="service:bicycle:repair" type="checkbox"></input></td>
        </tr>
        <tr class="bs">
          <td>Rental</td>
          <td><input id="service:bicycle:rental" type="checkbox"></input></td>
        </tr>
        <tr class="bs">
          <td>Second Hand</td>
          <td><input id="service:bicycle:second_hand" type="checkbox"></input></td>
        </tr>
        <tr class="bs">
          <td>Pump</td>
          <td><input id="service:bicycle:pump" type="checkbox"></input></td>
        </tr>
        <tr class="bs">
          <td>Cleaning</td>
          <td><input id="service:bicycle:cleaning" type="checkbox"></input></td>
        </tr>
        <tr class="bs">
          <td>Opening Hour</td>
          <td><input id="opening_hours" type="text"></input></td>
        </tr>
        <tr class="bs">
          <td>Phone</td>
          <td><input id="phone" type="tel"></input></td>
        </tr>
        <tr class="bs">
          <td>Email</td>
          <td><input id="email" type="email"></input></td>
        </tr>
        <tr class="bs">
          <td>Website</td>
          <td><input id="website" type="url"></input></td>
        </tr>
        <tr class="bs">
          <td>Facebook</td>
          <td><input id="facebook" type="url"></input></td>
        </tr>
        <tr class="bp">
          <td>Covered</td>
          <td><input id="covered" type="checkbox"></input></td>
        </tr>
        <tr class="bp">
          <td>Access</td>
          <td><input id="access" type="checkbox"></input></td>
        </tr>
        <tr class="bp br">
          <td>Capacity</td>
          <td><input id="capacity" type="text"></input></td>
        </tr>
        <tr class="bp">
          <td>Fee</td>
          <td><input id="fee" type="checkbox"></input></td>
        </tr>
        <tr class="bs bp br">
          <td>Operator</td>
          <td><input id="operator" type="text"></input></td>
        </tr>
        <tr class="visible">
          <td></td>
          <td>
            <input id="cancel" type="button" value="Cancel"></input>
            <input id="submit" type="button" value="Submit"></input>
          </td>
        </tr>
      </table>
     </div>
     <div id="msg">No Location</div>
     <div id="gpscheckbox">
       <input type="checkbox" id="gpscb" name="gpscb" checked="true"></input><label for="gpscb">GPS</label>
     </div>
     <div id="mapstylecheckbox">
       <input type="checkbox" id="mapstylecb" name="mapstylecb" checked="true"></input><label for="mapstylecb">Standard</label>
     </div>
     <div id="map"></div>
     <script>
      $(document).ready(function(){
        var bikeuser = Cookies.getJSON('bikeuser');
        if(bikeuser){
          /*$.ajax({
            type: "POST",
            url: "http://localhost:8080/checkuser",
            ContentType: 'application/json; charset=utf-8',
            data: {"username":userObj.username,"password":userObj.password},
            success: function(data){
              if(data.status == "SUCCESS"){
                $("#msgbox").html("Hello "+data.user.name).css("color","green").fadeIn(200).delay(4000).fadeOut(200);
                $("#name").html(data.user.name);
                $("#nrc").html(data.user.nrc);
                $("#dob").html(data.user.dob);
                $("#address").html(data.user.address);
                $("#tel").html(data.user.tel);
                $("#username").html(data.user.username);
                $("#password").html(data.user.password);
                $("#cardid").html(data.user.cardid);
                $("#balance").html(data.user.balance);
                for(i=0;i<data.user.history.length;i++){
                  var row = "<tr><td>"+data.user.history[i].date+"</td>"
                            + "<td>"+data.user.history[i].person+"</td>";
                  row = row + (data.user.history[i].type=="debit"?("<td>"+data.user.history[i].amount+"</td><td></td></tr>"):("<td></td><td>"+data.user.history[i].amount+"</td></tr>"));
                  $("#historytable tr:last").after(row);
                }
              } else {
                $.redirect("http://localhost:8080/");
              }
            }
          });*/
        }else{
          $.redirect("https://wherebikes.herokuapp.com/login",{},"GET");
        }
        var poi;
        var bikeShopIcon = L.icon({
          iconUrl: "https://wherebikes.herokuapp.com/shop.png",
          //shadowUrl: 'leaf-shadow.png',

          iconSize:     [30, 30], // size of the icon
          //shadowSize:   [50, 64], // size of the shadow
          //iconAnchor:   [25, 25], // point of the icon which will correspond to marker's location
          //shadowAnchor: [4, 62],  // the same for the shadow
          popupAnchor:  [0, -15] // point from which the popup should open relative to the iconAnchor
        });
        var bikeParkingIcon = L.icon({
          iconUrl: "https://wherebikes.herokuapp.com/parking.png",
          //shadowUrl: 'leaf-shadow.png',

          iconSize:     [30, 30], // size of the icon
          //shadowSize:   [50, 64], // size of the shadow
          //iconAnchor:   [25, 25], // point of the icon which will correspond to marker's location
          //shadowAnchor: [4, 62],  // the same for the shadow
          popupAnchor:  [0, -15] // point from which the popup should open relative to the iconAnchor
        });
        var bikeRentalIcon = L.icon({
          iconUrl: "https://wherebikes.herokuapp.com/rental.png",
          //shadowUrl: 'leaf-shadow.png',

          iconSize:     [30, 30], // size of the icon
          //shadowSize:   [50, 64], // size of the shadow
          //iconAnchor:   [25, 25], // point of the icon which will correspond to marker's location
          //shadowAnchor: [4, 62],  // the same for the shadow
          popupAnchor:  [0, -15] // point from which the popup should open relative to the iconAnchor
        });
        var map = L.map('map').setView([16.8512554,96.1669349], 13);
        var standardTileLayer = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                          maxZoom: 19,
                          attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                        });
        var humanTileLayer = L.tileLayer('http://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
                          maxZoom: 20,
                          attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                        });
        standardTileLayer.addTo(map);
        function populateMap(){
          $.ajax({
            type: "GET",
            url: "https://wherebikes.herokuapp.com/dataset",
            ContentType: 'application/json; charset=utf-8',
            dataType: 'json',
            success: function(dataset){
              if(dataset.length>0){
                for(var i=0;i<dataset.length;i++){
                  data = dataset[i];
                  L.marker(L.latLng(data.lat,data.lon),{draggable:false,icon:bikeIcon}).bindPopup("<strong>"+data.name+"</strong>").addTo(map);
                }
              }
            }
          });
        }
        populateMap();
        if($("#gpscb").is(":checked")){
          map.locate({setView: true, maxZoom: 18, enableHighAccuracy: true, watch: true});
        }
        $("#gpscb").change(function(){
          if(this.checked){
             map.locate({setView: true, maxZoom: 18, enableHighAccuracy: true, watch: true});
          } else {
             map.stopLocate();
          }
        })
        $("#mapstylecb").change(function(){
          if(this.checked){
             map.removeLayer(humanTileLayer);
             standardTileLayer.addTo(map);
          } else {
             map.removeLayer(standardTileLayer);
             humanTileLayer.addTo(map);
          }
        })
        var marker = L.marker(map.getCenter(),{draggable:false}).addTo(map);
        marker.on('click', function(e){
          $("#container").css("display","flex");
        });

        var circle;
        function onLocationFound(e) {
          if(circle!=undefined){
            circle.setRadius(e.accuracy/2);
          } else{
            circle = L.circle(e.latlng,e.accuracy/2).addTo(map);
          }
        }
        map.on('locationfound', onLocationFound);

        function onLocationError(e) {
          if(circle!=undefined){
            map.removeLayer(circle);
          }
          circle = undefined;
          alert(e.message);
        }
        map.on('locationerror', onLocationError);

        function onMapMove(e){
          poi = L.latLng(map.getCenter().lat,map.getCenter().lng);
          poi = poi.wrap();
          marker.setLatLng(poi);
          if(circle!=undefined){
            circle.setLatLng(poi);
          }
          $("#msg").html(poi.lat.toFixed(6)+" : "+poi.lng.toFixed(6));
        }
        map.on('move',onMapMove);
        $(".bp").hide();
        $(".br").hide();
        $(".bs").show();
        $("#category").on("change",function(){
          switch($("#category").val()){
            case "shop=bicycle":
              $(".bp").hide(200);
              $(".br").hide(200);
              $(".bs").show(200);
              break;
            case "amenity=bicycle_parking":
              $(".bs").hide(200);
              $(".br").hide(200);
              $(".bp").show(200);
              break;
            case "amenity=bicycle_rental":
              $(".bs").hide(200);
              $(".bp").hide(200);
              $(".br").show(200);
              break;
          }
        });
        $("#cancel").on("click",function(){
          $("#container").hide();
        });

        function createDataReq(className){
          var request = {};
          request["username"] = bikeuser.username;
          request["password"] = bikeuser.password;
          request["lat"] = poi.lat;
          request["lon"] = poi.lng;
          $("."+className+" :nth-child(2) :first-child").each(function(){
            if($(this).prop("type")=="checkbox"){
              if($(this).is(":checked")){
                request[$(this).prop("id")] = "yes";
              }
            } else {
                if($(this).val().length>0){
                  request[$(this).prop("id")] = $(this).val();
                }
            }
          });
          return request;
        }
        $("#submit").on("click",function(){
          var req_data;
          switch($("#category").val()){
            case "shop=bicycle":
                req_data = createDataReq("bs");
                req_data["shop"] = "bicycle";
              break;
            case "amenity=bicycle_parking":
                req_data = createDataReq("bp");
                req_data["amenity"] = "bicycle_parking";
              break;
            case "amenity=bicycle_rental":
                req_data = createDataReq("br");
                req_data["amenity"] = "bicycle_rental";
              break;
          }
          $.ajax({
            type: "POST",
            url: "https://wherebikes.herokuapp.com/insert",
            ContentType: 'application/json; charset=utf-8',
            data: req_data,
            success: function(data){
              if(data.status == "SUCCESS"){
                var bikeIcon;
                if(data.shop){
                  icon = bikeIcon;
                }else if(data.amenity=="bicycle_parking"){
                  icon = bikeParkingIcon;
                }else if(data.amenity=="bicycle_rental"){
                  icon = bikeRentalIcon;
                }
                L.marker(L.latLng(data.lat,data.lon),{draggable:false,icon:bikeIcon}).bindPopup("<strong>"+(data.name?data.name:"")+"</strong>").addTo(map);
                $(":input").each(function(){
                  if($(this).prop("type")=="checkbox"){
                    $(this).prop("checked",false);
                  } else if($(this).prop("type")!=="button"||$(this).prop("type")!=="button"){
                    $(this).val("");
                  }
                });
                $("#container").hide();
              } else {
                alert("Error Inserting");
              }
            }
          });
        });
      });
     </script>
  </body>
</html>
