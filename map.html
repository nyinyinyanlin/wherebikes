<html>
  <head>
    <title></title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"
            integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
            crossorigin="anonymous"></script>
    <script src="https://cdn.rawgit.com/mgalante/jquery.redirect/master/jquery.redirect.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"
          integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ=="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"
            integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log=="
            crossorigin=""></script>
    <style>
      html, body, #map {
        height: 100%;
        width: 100vw;
        margin: 0;
        padding: 0;
      }

      body {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      #container {
        width: 100vw;
        height: 100%;
        background-color: white;
        position: absolute;
        display: none;
        overflow: scroll;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        z-index: 4;
      }

      #map {
        position: absolute;
        display: block;
        z-index: 1;
      }

      #msg {
        position: absolute;
        top: 2%;
        height: 24px;
        width: auto;
        text-align: center;
        background-color: white;
        border-radius: 5px;
        padding: 2px 8px 2px 8px;
        box-shadow: 0px 0px 2px 1px #888888;
        z-index: 2;
      }

      #gpscheckbox {
        position: absolute;
        bottom: 5%;
        left: 3%;
        width: auto;
        padding: 2px 8px 2px 5px;
        border-radius: 5px;
        background-color: white;
        box-shadow: 0px 0px 2px 1px #888888;
        z-index: 3;
      }

      #gpscb {
        vertical-align: middle;
        height: 16px;
        width: 16px;
      }

      #mapstylecheckbox {
        position: absolute;
        bottom: 5%;
        right: 3%;
        width: auto;
        padding: 2px 8px 2px 5px;
        border-radius: 5px;
        background-color: white;
        box-shadow: 0px 0px 2px 1px #888888;
        z-index: 3;
      }

      #mapstylecb {
        vertical-align: middle;
        height: 16px;
        width: 16px;
      }

      .visible {
        visibility: visible;
      }

      .bp, .br{
        display: none;
      }

      .bs {
        display: table-row;
      }

      table {
        width: 100%;
      }

      table tr {
        width: 100%;
      }

      table tr td {
        width: 60%;
      }

      table tr td:first-child {
        text-align: right;
        width: 40%;
      }
    </style>
  </head>
  <body>
     <div id="container">
      <table>
        <tr class="visible">
          <td>Category:</td>
          <td>
            <select size="1" id="category">
              <option value="Bicycle Shop">Bicycle Shop</option>
              <option value="Bicycle Parking">Bicycle Parking</option>
              <option value="Bicycle Rental">Bicycle Rental</option>
            </select>
          </td>
        </tr>
        <tr class="bs">
          <td>Name (ENG)</td>
          <td><input id="engname" type="text"></input></td>
        </tr>
        <tr class="bs">
          <td>Name (BUR)</td>
          <td><input id="burname" type="text"></input></td>
        </tr>
        <tr class="bs">
          <td>Address</td>
          <td><input id="address" type="text"></input></td>
        </tr>
        <tr class="bs">
          <td>Building No.</td>
          <td><input id="building" type="text"></input></td>
        </tr>
        <tr class="bs">
          <td>Zip Code</td>
          <td><input id="zipcode" type="text"></input></td>
        </tr>
        <tr class="bs br">
          <td>Business Hour</td>
          <td><input id="businesshour" type="text"></input></td>
        </tr>
        <tr class="bs">
          <td>Phone</td>
          <td><input id="phone" type="text"></input></td>
        </tr>
        <tr class="bs br">
          <td>Website</td>
          <td><input id="website" type="text"></input></td>
        </tr>
        <tr class="bs">
          <td>Email</td>
          <td><input id="email" type="text"></input></td>
        </tr>
        <tr class="bs br bp">
          <td>Owner</td>
          <td><input id="owner" type="text"></input></td>
        </tr>
        <tr class="bs br bp">
          <td>Comment</td>
          <td><textarea id="comment"></textarea></td>
        </tr>
        <tr class="bs br bp">
          <td></td>
          <td>
            <input id="cancel" type="button" value="Cancel"></input>
            <input id="submit" type="button" value="Submit"></input>
          </td>
        </tr>
      </table>
     </div>
     <div id="msg">No Location</div>
     <div id="gpscheckbox">
       <input type="checkbox" id="gpscb" name="gpscb" checked="true"></input><label for="gpscb">GPS</label>
     </div>
     <div id="mapstylecheckbox">
       <input type="checkbox" id="mapstylecb" name="mapstylecb" checked="true"></input><label for="mapstylecb">Standard</label>
     </div>
     <div id="map"></div>
     <script>
      $(document).ready(function(){
        var bikeuser = Cookies.getJSON('bikeuser');
        if(bikeuser){
          /*$.ajax({
            type: "POST",
            url: "http://localhost:8080/checkuser",
            ContentType: 'application/json; charset=utf-8',
            data: {"username":userObj.username,"password":userObj.password},
            success: function(data){
              if(data.status == "SUCCESS"){
                $("#msgbox").html("Hello "+data.user.name).css("color","green").fadeIn(200).delay(4000).fadeOut(200);
                $("#name").html(data.user.name);
                $("#nrc").html(data.user.nrc);
                $("#dob").html(data.user.dob);
                $("#address").html(data.user.address);
                $("#tel").html(data.user.tel);
                $("#username").html(data.user.username);
                $("#password").html(data.user.password);
                $("#cardid").html(data.user.cardid);
                $("#balance").html(data.user.balance);
                for(i=0;i<data.user.history.length;i++){
                  var row = "<tr><td>"+data.user.history[i].date+"</td>"
                            + "<td>"+data.user.history[i].person+"</td>";
                  row = row + (data.user.history[i].type=="debit"?("<td>"+data.user.history[i].amount+"</td><td></td></tr>"):("<td></td><td>"+data.user.history[i].amount+"</td></tr>"));
                  $("#historytable tr:last").after(row);
                }
              } else {
                $.redirect("http://localhost:8080/");
              }
            }
          });*/
        }else{
          $.redirect("https://wherebikes.herokuapp.com/login",{},"GET");
        }
        var poi;
        var bikeIcon = L.icon({
          iconUrl: "https://wherebikes.herokuapp.com/bike.png",
          //shadowUrl: 'leaf-shadow.png',

          iconSize:     [30, 30], // size of the icon
          //shadowSize:   [50, 64], // size of the shadow
          //iconAnchor:   [25, 25], // point of the icon which will correspond to marker's location
          //shadowAnchor: [4, 62],  // the same for the shadow
          popupAnchor:  [0, -28] // point from which the popup should open relative to the iconAnchor
        });
        var map = L.map('map').setView([16.8512554,96.1669349], 13);
        var standardTileLayer = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                          maxZoom: 19,
                          attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                        });
        var humanTileLayer = L.tileLayer('http://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
                          maxZoom: 20,
                          attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                        });
        standardTileLayer.addTo(map);
        $.ajax({
          type: "GET",
          url: "https://wherebikes.herokuapp.com/dataset",
          ContentType: 'application/json; charset=utf-8',
          dataType: 'json',
          success: function(dataset){
            if(dataset.length>0){
              for(var i=0;i<dataset.length;i++){
                data = dataset[i];
                L.marker(L.latLng(data.lat,data.lng),{draggable:false,icon:bikeIcon}).bindPopup("<strong>"+data.name+"</strong>").addTo(map);
              }
            }
          }
        });
        if($("#gpscb").is(":checked")){
          map.locate({setView: true, maxZoom: 18, enableHighAccuracy: true, watch: true});
        }
        $("#gpscb").change(function(){
          if(this.checked){
             map.locate({setView: true, maxZoom: 18, enableHighAccuracy: true, watch: true});
          } else {
             map.stopLocate();
          }
        })
        $("#mapstylecb").change(function(){
          if(this.checked){
             map.removeLayer(humanTileLayer);
             standardTileLayer.addTo(map);
          } else {
             map.removeLayer(standardTileLayer);
             humanTileLayer.addTo(map);
          }
        })
        var marker = L.marker(map.getCenter(),{draggable:false}).addTo(map);
        marker.on('click', function(e){
          $("#container").css("display","flex");
        });

        var circle;
        function onLocationFound(e) {
          if(circle!=undefined){
            circle.setRadius(e.accuracy/2);
          } else{
            circle = L.circle(e.latlng,e.accuracy/2).addTo(map);
          }
        }
        map.on('locationfound', onLocationFound);

        function onLocationError(e) {
          if(circle!=undefined){
            map.removeLayer(circle);
          }
          circle = undefined;
          alert(e.message);
        }
        map.on('locationerror', onLocationError);

        function onMapMove(e){
          poi = L.latLng(map.getCenter().lat,map.getCenter().lng);
          poi = poi.wrap();
          marker.setLatLng(poi);
          if(circle!=undefined){
            circle.setLatLng(poi);
          }
          $("#msg").html(poi.lat.toFixed(6)+" : "+poi.lng.toFixed(6));
        }
        map.on('move',onMapMove);
        $("#category").on("change",function(){
          switch($("#category").val()){
            case "Bicycle Shop":
              $(".bp").hide(200);
              $(".br").hide(200);
              $(".bs").show(200);
              break;
            case "Bicycle Parking":
              $(".bs").hide(200);
              $(".br").hide(200);
              $(".bp").show(200);
              break;
            case "Bicycle Rental":
              $(".bs").hide(200);
              $(".bp").hide(200);
              $(".br").show(200);
              break;
          }
        });
        $("#cancel").on("click",function(){
          $("#container").hide();
        });
      });
     </script>
  </body>
</html>
